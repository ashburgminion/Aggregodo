{%- extends "base.njk" -%}
{%- block section -%}
  {%- if feed -%}Feed{%- endif -%}
{%- endblock -%}
{%- block title -%}
  {%- if feed -%}{{ feed.name }} | Feed{%- endif -%}
{%- endblock -%}
{%- block classes -%}
  {%- if Prefs.DefaultView == 'grid' -%} grid-layout {%- endif -%}
  {%- if Prefs.DefaultView == 'list' -%} list-layout {%- endif -%}
{%- endblock -%}
{%- block menuitems -%}
  {%- if feed -%}
    <li><button class="mdl-menu__item" onclick="navigator.clipboard.writeText(location.href + '/atom');">Copy Bridge URL</button></li>
    {# { % if Config.Development % }
      <li><button class="mdl-menu__item">Update Feed</button></li>
    { % endif % } #}
  {%- endif -%}
{%- endblock -%}
{%- block content -%}
  {% if feed %}
    <div class="-mdl-layout__header-row" style="padding: 0 16px; display: flex;">
      <div>
        <h3 style="word-break: break-word;">
          <div class="minilogo" style="float: left; background-image: url('{{ feed.icon }}');">
            {% if not feed.icon %}<i class="material-icons">feed</i>{% endif %}
          </div>
          <span>{{ feed.name }}</span>
        </h3>
        <p style="word-break: break-word;"><a href="{{ feed.url }}" target="_blank" class="link-iconed">
          <i class="material-icons">open_in_new</i>
          {{ feed.url }}
        </a></p>
        {% if feed.description %}
          <p>
            {% for line in feed.description.split('\n') %}
              {{ line }}<br />
            {% endfor %}
          </p>
        {% endif %}
      </div>
      <div class="mdl-layout-spacer" style="word-break: break-word;"></div>
      <div style="padding: /* 0 8px */ 24px 0;">
        <button id="copy-link" class="mdl-button mdl-js-button mdl-button--icon" onclick="navigator.clipboard.writeText(location.href);">
          <i class="material-icons">link</i>
        </button>
        <span for="copy-link" class="mdl-tooltip">Copy Link</span>
      </div>
    </div>
  {% endif %}

  {# <div class="rss-content"> #}
    <div class="top-actions">
      <div style="flex: 1;">
        {# abc #}
      </div>
      <div class="layout-toggle">
        {# <button id="grid-view" title="Grid View" class="mdl-button mdl-js-button mdl-button--icon mdl-button--active">
          <i class="material-icons">view_module</i>
        </button>
        <button id="list-view" title="List View" class="mdl-button mdl-js-button mdl-button--icon">
          <i class="material-icons">view_list</i>
        </button> #}
        <label class="mdl-icon-toggle mdl-js-icon-toggle mdl-js-ripple-effect" for="grid-view" title="Grid View">
          <input type="radio" id="grid-view" class="mdl-icon-toggle__input" name="layout-toggle" {% if Prefs.DefaultView == 'grid' %} checked {% endif %} />
          <i class="mdl-icon-toggle__label material-icons">view_module</i>
        </label>
        <label class="mdl-icon-toggle mdl-js-icon-toggle mdl-js-ripple-effect" for="list-view" title="List View">
          <input type="radio" id="list-view" class="mdl-icon-toggle__input" name="layout-toggle" {% if Prefs.DefaultView == 'list' %} checked {% endif %} />
          <i class="mdl-icon-toggle__label material-icons">view_list</i>
        </label>
      </div>
    </div>
    
    <!-- Grid Layout -->
    <div id="grid-layout" class="mdl-grid -rss-grid">
      {# <!-- Sample RSS Item 1 -->
      <a href="#" class="mdl-card mdl-shadow--2dp rss-card mdl-cell">
        <div class="rss-card-image">
          <img src="https://picsum.photos/600/400?random=1" alt="Article Image">
        </div>
        <div class="rss-card-content">
          <div class="rss-card-title">Understanding Material Design Principles for Modern Apps</div>
          <div class="rss-card-preview">A deep dive into how Material Design can improve user experience and create visually appealing applications that follow Google's design guidelines.</div>
        </div>
        <div class="rss-card-meta">
          <span>Tech Blog</span>
          <span>2 hours ago</span>
        </div>
      </a>
      
      <!-- Sample RSS Item 2 -->
      <a href="#" class="mdl-card mdl-shadow--2dp rss-card mdl-cell">
        <div class="rss-card-image">
          <img src="https://picsum.photos/600/400?random=2" alt="Article Image">
        </div>
        <div class="rss-card-content">
          <div class="rss-card-title">The Future of Web Development in 2023</div>
          <div class="rss-card-preview">Exploring emerging trends and technologies that are shaping the future of web development, from WebAssembly to progressive web apps.</div>
        </div>
        <div class="rss-card-meta">
          <span>Dev Weekly</span>
          <span>5 hours ago</span>
        </div>
      </a>
      
      <!-- Sample RSS Item 3 -->
      <a href="#" class="mdl-card mdl-shadow--2dp rss-card mdl-cell">
        <div class="rss-card-image">
          <img src="https://picsum.photos/600/400?random=3" alt="Article Image">
        </div>
        <div class="rss-card-content">
          <div class="rss-card-title">How to Build Responsive Layouts with CSS Grid</div>
          <div class="rss-card-preview">Learn how to create flexible, responsive web layouts using CSS Grid, with practical examples and best practices for modern web design.</div>
        </div>
        <div class="rss-card-meta">
          <span>CSS Tricks</span>
          <span>1 day ago</span>
        </div>
      </a>
      
      <!-- Sample RSS Item 4 -->
      <a href="#" class="mdl-card mdl-shadow--2dp rss-card mdl-cell">
        <div class="rss-card-image">
          <img src="https://picsum.photos/600/400?random=4" alt="Article Image">
        </div>
        <div class="rss-card-content">
          <div class="rss-card-title">JavaScript Performance Optimization Techniques</div>
          <div class="rss-card-preview">Discover advanced techniques to optimize your JavaScript code for better performance and smoother user experiences in web applications.</div>
        </div>
        <div class="rss-card-meta">
          <span>JS Monthly</span>
          <span>1 day ago</span>
        </div>
      </a>
      
      <!-- Sample RSS Item 5 -->
      <a href="#" class="mdl-card mdl-shadow--2dp rss-card mdl-cell">
        <div class="rss-card-image">
          <img src="https://picsum.photos/600/400?random=5" alt="Article Image">
        </div>
        <div class="rss-card-content">
          <div class="rss-card-title">The Rise of Progressive Web Apps</div>
          <div class="rss-card-preview">How PWAs are bridging the gap between web and mobile apps, offering native-like experiences with the reach of the web.</div>
        </div>
        <div class="rss-card-meta">
          <span>Web Trends</span>
          <span>2 days ago</span>
        </div>
      </a>
      
      <!-- Sample RSS Item 6 -->
      <a href="#" class="mdl-card mdl-shadow--2dp rss-card mdl-cell">
        <div class="rss-card-image">
          <img src="https://picsum.photos/600/400?random=6" alt="Article Image">
        </div>
        <div class="rss-card-content">
          <div class="rss-card-title">Accessibility in Modern Web Design</div>
          <div class="rss-card-preview">Why accessibility matters and how to implement inclusive design practices to make your websites usable by everyone.</div>
        </div>
        <div class="rss-card-meta">
          <span>Design Matters</span>
          <span>3 days ago</span>
        </div>
      </a> #}

      {% for entry in entries %}
        <a rel="noopener"
          {% if Prefs.ReaderMode %}
            href="{{ urlFor('/entry/:entry', { entry: slugifyUrl(entry.link) }) }}"
          {% else %}
            href="{{ entry.link }}" target="_blank"
          {% endif %}
        class="mdl-card mdl-shadow--2dp rss-card mdl-cell">
          <div class="rss-card-image">
            {% if entry.embed %}
              <iframe {% if entry.image %} style="background-image: url('{{ entry.image }}');" {% endif %} src="{{ entry.embed }}" loading="lazy" allow="fullscreen" allowfullscreen></iframe>
            {% elif entry.video %}
              <video src="{{ entry.video }}" controls></video>
            {% elif entry.image %}
              <img src="{{ entry.image }}" loading="lazy" />
            {% endif %}
          </div>
          <div class="rss-card-content">
            <div class="rss-card-title">{{ entry.title }}</div>
            <div class="rss-card-preview">{{ entry.summary }}</div>
          </div>
          <div class="rss-card-meta">
            <span>
              <i class="material-icons" style=" font-size: 20px; float: left; margin-right: 8px;">feed</i>
              {{ feeds[entry.feedId].name }}
            </span>
            <span class="time">{{ entry.published }}</span>
          </div>
        </a>
      {% endfor %}
    </div>
    
    <!-- List Layout -->
    <div id="list-layout" class="rss-list {# layout-hidden #}">
      {# <!-- Sample RSS Item 1 -->
      <a href="#" class="rss-list-item">
        <div class="rss-list-image">
          <img src="https://picsum.photos/300/225?random=1" alt="Article Image">
        </div>
        <div class="rss-list-content">
          <div class="rss-list-title">Understanding Material Design Principles for Modern Apps</div>
          <div class="rss-list-preview">A deep dive into how Material Design can improve user experience and create visually appealing applications that follow Google's design guidelines.</div>
          <div class="rss-list-meta">
            <span>Tech Blog</span>
            <span>2 hours ago</span>
          </div>
        </div>
      </a>
      
      <!-- Sample RSS Item 2 -->
      <a href="#" class="rss-list-item">
        <div class="rss-list-image">
          <img src="https://picsum.photos/300/225?random=2" alt="Article Image">
        </div>
        <div class="rss-list-content">
          <div class="rss-list-title">The Future of Web Development in 2023</div>
          <div class="rss-list-preview">Exploring emerging trends and technologies that are shaping the future of web development, from WebAssembly to progressive web apps.</div>
          <div class="rss-list-meta">
            <span>Dev Weekly</span>
            <span>5 hours ago</span>
          </div>
        </div>
      </a>
      
      <!-- Sample RSS Item 3 -->
      <a href="#" class="rss-list-item">
        <div class="rss-list-image">
          <img src="https://picsum.photos/300/225?random=3" alt="Article Image">
        </div>
        <div class="rss-list-content">
          <div class="rss-list-title">How to Build Responsive Layouts with CSS Grid</div>
          <div class="rss-list-preview">Learn how to create flexible, responsive web layouts using CSS Grid, with practical examples and best practices for modern web design.</div>
          <div class="rss-list-meta">
            <span>CSS Tricks</span>
            <span>1 day ago</span>
          </div>
        </div>
      </a>
      
      <!-- Sample RSS Item 4 -->
      <a href="#" class="rss-list-item">
        <div class="rss-list-image">
          <img src="https://picsum.photos/300/225?random=4" alt="Article Image">
        </div>
        <div class="rss-list-content">
          <div class="rss-list-title">JavaScript Performance Optimization Techniques</div>
          <div class="rss-list-preview">Discover advanced techniques to optimize your JavaScript code for better performance and smoother user experiences in web applications.</div>
          <div class="rss-list-meta">
            <span>JS Monthly</span>
            <span>1 day ago</span>
          </div>
        </div>
      </a>
      
      <!-- Sample RSS Item 5 -->
      <a href="#" class="rss-list-item">
        <div class="rss-list-image">
          <img src="https://picsum.photos/300/225?random=5" alt="Article Image">
        </div>
        <div class="rss-list-content">
          <div class="rss-list-title">The Rise of Progressive Web Apps</div>
          <div class="rss-list-preview">How PWAs are bridging the gap between web and mobile apps, offering native-like experiences with the reach of the web.</div>
          <div class="rss-list-meta">
            <span>Web Trends</span>
            <span>2 days ago</span>
          </div>
        </div>
      </a>
      
      <!-- Sample RSS Item 6 -->
      <a href="#" class="rss-list-item">
        <div class="rss-list-image">
          <img src="https://picsum.photos/300/225?random=6" alt="Article Image">
        </div>
        <div class="rss-list-content">
          <div class="rss-list-title">Accessibility in Modern Web Design</div>
          <div class="rss-list-preview">Why accessibility matters and how to implement inclusive design practices to make your websites usable by everyone.</div>
          <div class="rss-list-meta">
            <span>Design Matters</span>
            <span>3 days ago</span>
          </div>
        </div>
      </a> #}

      {% for entry in entries %}
        <a rel="noopener"
          {% if Prefs.ReaderMode %}
            href="{{ urlFor('/entry/:entry', { entry: slugifyUrl(entry.link) }) }}"
          {% else %}
            href="{{ entry.link }}" target="_blank"
          {% endif %}
        class="rss-list-item">
          <div class="rss-list-image">
            {% if entry.video %}
              <video src="{{ entry.video }}" controls></video>
            {% elif entry.image %}
              <img src="{{ entry.image }}" loading="lazy" />
            {% endif %}
          </div>
          <div class="rss-list-content">
            <div class="rss-list-title">{{ entry.title or ('&nbsp;' | safe) }}</div>
            <div class="rss-list-preview">{{ entry.summary }}</div>
            <div class="rss-list-meta">
              <span>
                <i class="material-icons" style=" font-size: 20px; float: left; margin-right: 8px;">feed</i>
                {{ feeds[entry.feedId].name }}
              </span>
              <span class="time">{{ entry.published }}</span>
            </div>
          </div>
        </a>
      {% endfor %}
    </div>
  {# </div> #}

  <div class="mdl-grid">
    <nav class="demo-nav {# mdl-color-text--grey-600 mdl-color-text--grey-50 #} mdl-cell mdl-cell--12-col">
      {% if page > 1 %}
        <a href="?page={{ page - 1 }}{% if search %}&search={{ search }}{% endif %}" class="demo-nav__button">
          <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation" data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons">arrow_back</i>
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>
          Newer
        </a>
      {% endif %}
      <div class="section-spacer"></div>
      {% if next %}
        <a href="?page={{ next }}{% if search %}&search={{ search }}{% endif %}" class="demo-nav__button">
          Older
          <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation" data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons">arrow_forward</i>
          <span class="mdl-button__ripple-container"><span class="mdl-ripple"></span></span></button>
        </a>
      {% endif %}
    </nav>
  </div>

  <script>
    // Layout toggle functionality
    // document.addEventListener('DOMContentLoaded', function() {
    const gridViewButton = document.getElementById('grid-view');
    const listViewButton = document.getElementById('list-view');
    const gridLayout = document.getElementById('grid-layout');
    const listLayout = document.getElementById('list-layout');
    
    gridViewButton.addEventListener('click', function() {
      document.body.classList.remove('list-layout');
      document.body.classList.add('grid-layout');
      // gridLayout.classList.remove('layout-hidden');
      // listLayout.classList.add('layout-hidden');
      // gridViewButton.classList.add('mdl-button--active');
      // listViewButton.classList.remove('mdl-button--active');
      gridViewButton.checked = true;
      listViewButton.checked = false;
      listViewButton.parentElement.classList.remove('is-checked');
      localStorage.setItem('defaultView', 'grid');
    });
    
    listViewButton.addEventListener('click', function() {
      document.body.classList.remove('grid-layout');
      document.body.classList.add('list-layout');
      // listLayout.classList.remove('layout-hidden');
      // gridLayout.classList.add('layout-hidden');
      // listViewButton.classList.add('mdl-button--active');
      // gridViewButton.classList.remove('mdl-button--active');
      listViewButton.checked = true;
      gridViewButton.checked = false;
      gridViewButton.parentElement.classList.remove('is-checked');
      localStorage.setItem('defaultView', 'list');
    });
    // });

    const defaultView = localStorage.getItem('defaultView', 'grid');
    if (defaultView) {
      gridViewButton.checked = listViewButton.checked = false;
      document.body.classList.remove('grid-layout');
      document.body.classList.remove('list-layout');
      document.body.classList.add(`${defaultView}-layout`);
      document.getElementById(`${defaultView}-view`).checked = true;
    }

    {# const evtSource = new EventSource('/events');
    console.log(evtSource.withCredentials);
    console.log(evtSource.readyState);
    console.log(evtSource.url);

    evtSource.onmessage = (e) => {
      console.log(e)
      const data = JSON.parse(e.data);
      if (data.updated) {
        alert('New feed items available!');
      }
    };

    evtSource.onopen = function() {
      console.log("Connection to server opened.");
    };

    evtSource.onmessage = function(e) {
      const newElement = document.createElement("li");

      newElement.textContent = "message: " + e.data;
      eventList.appendChild(newElement);
    };

    evtSource.onerror = function() {
      console.log("EventSource failed.");
    }; #}

    {# const ws = new WebSocket('ws://localhost:3000/ws');

    ws.onopen = () => {
      console.log('Connected to server');
      ws.send('hi from client!!!');
    };

    ws.onmessage = (event) => {
      console.log('Server says:', event.data);
    };

    ws.onclose = () => {
      console.log('Disconnected');
    }; #}

    function createWebSocket(url, onmessage) {
      let ws;
      let reconnectInterval = 1000; // 1 second
      let maxRetries = 10;
      let retries = 0;

      function connect() {
        ws = new WebSocket(url);

        ws.onopen = () => {
          console.log('‚úÖ Connected');
          retries = 0; // reset on success
        };

        ws.onmessage = onmessage;
        {# ws.onmessage = (event) => {
          console.log('üì® Message:', event.data);
        }; #}

        ws.onclose = (event) => {
          console.warn('‚ö†Ô∏è Disconnected:', event.reason);
          if (retries < maxRetries) {
            setTimeout(connect, reconnectInterval);
            retries++;
            reconnectInterval *= 2; // exponential backoff
          } else {
            console.error('‚ùå Max retries reached');
          }
        };

        ws.onerror = (err) => {
          console.error('üí• WebSocket error:', err.message);
          ws.close(); // trigger onclose
        };
      }

      connect();
    }

    const loadSpinner = document.getElementById('load-spinner');
    const reloadButton = document.getElementById('reload-button');

    createWebSocket('/ws', (event) => {
      // console.log(event);
      switch (event.data) {
        case 'FEED_UPDATE_STARTED':
        case 'FEEDS_UPDATE_STARTED':
        case 'FEEDS_UPDATE_RUNNING':
          loadSpinner.hidden = false;
          reloadButton.hidden = true;
          break;
        case 'FEED_UPDATE_FINISHED':
        case 'FEEDS_UPDATE_FINISHED':
          loadSpinner.hidden = true;
          reloadButton.hidden = false;
          break;
      }
    });
  </script>
{%- endblock -%}